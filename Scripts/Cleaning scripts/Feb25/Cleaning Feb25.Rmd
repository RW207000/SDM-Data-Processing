---
title: "Cleaning Feb25"
author: "R.Welch"
date: "2025-05-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*********************************
*********************************
------Script set up------

```{r : reading libraries, include= FALSE}
packages <- c("tidyverse", "readxl", "dplyr", "magrittr", "mixtools", "emmeans", "readr","data.table", "lubridate", "ggplot2", "magrittr", "skimr", "ggstatsplot","summarytools", "knitr", "here", "ggthemes", "ggthemes", "Amelia", "tidyr", "naniar", "stringr", "janitor", "readxl")

lapply(packages, library, character.only = TRUE)
```


```{r : reading in data}
participants <- read.csv("Data/1 Registry extracts/Feb 25 Extract/Longitudinal data 24.02.2025.csv",header=T, na.strings="")
participants$Date.of.Assessment <- as.Date(participants$Date.of.Assessment, format = "%d/%m/%Y")

medication <- read.csv("Data/1 Registry extracts/Feb 25 Extract/Glucocorticoids Data 24.02.2025.csv", header=T, na.strings= c("", "NA"))
medication <- remove_empty(medication, c("cols"), cutoff = 1)

labs <- read.csv("Data/1 Registry extracts/Feb 25 Extract/Labs data 24.02.2025.csv", header=T, na.strings= c("", "NA"))
labs$Date <- as.Date(labs$Date, format = "%d/%m/%Y")
```

*********************************
*********************************
------Removing duplicates------

Making unique identifier for each assessment by combining co-id and assessment date.
```{r : making new unique identifier}
participants$coid_assedate <- paste(participants$CO.ID, participants$Date.of.Assessment, sep = " ")
```

Checking for any duplicate entries (i.e.: any duplicates in the newly made unique identifier).
'list of duplicates frame' gives output of duplicate candidates
```{r : checking for duplicates}
duplicates <- freq(participants$coid_assedate)
duplicatesframe <- as.data.frame(duplicates)
duplicatesframe <- rownames_to_column(duplicatesframe, var="idvisitdate")
```

Now to remove any non-duplicates in 'duplicatesframe' to show us what the actual duplicates are and how many times they've been duplicated
```{r : isolating duplicate occurances, include= FALSE}
duplicatesframe <- duplicatesframe[duplicatesframe$idvisitdate != c("Total", "<NA>"),]
duplicatesframe <- duplicatesframe[-c(3:6)]

duplicateassessments <- duplicatesframe %>%
  filter(Freq>1)
```

Make a new vector to use as list of duplicate entries to remove from participants dataframe and then remove duplicated entries from participants dataframe with a subset.
Because there's no way of knowing which duplicate entry is the correct one, all duplicates are removed.
```{r : removing duplicates, include=FALSE}
idvisitstoremove <- duplicateassessments$idvisitdate

participantsnoduplicates <- subset(participants, !coid_assedate %in% idvisitstoremove)

freqcheck <- as.data.frame(freq(participantsnoduplicates$coid_assedate))
freqcheck <- rownames_to_column(freqcheck, var="idvisitdate")
freqcheck <- freqcheck[freqcheck$idvisitdate != c("Total", "<NA>"),]

# freqcheck
```

Making a dataframe of the removed duplicate assessment entries
```{r : removed duplicates}
toremove <- duplicateassessments$idvisitdate
removedrecords <- subset(participants, coid_assedate %in% toremove)

write.csv(removedrecords, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/removed_records", row.names = F)
```

Because I've removed all duplicate assessment entries, we might have lost participant/s if their only entry is one of these removed duplicates.
This will show which participants, if any, have been lost.
```{r : identifying lost participants}
duplicateassessments$id <- sapply(strsplit(duplicateassessments$idvisitdate," "), `[`, 1)
duplicateassessments$visitdate<- sapply(strsplit(duplicateassessments$idvisitdate," "), `[`, 2)

toremovelostparticipants <- participantsnoduplicates$CO.ID

lostparticipants <- NA
lostparticipants <- subset(participants, !CO.ID %in% toremovelostparticipants)
```

```{r : making participantsnoduplicates}
idvisitstoremove <- duplicateassessments$idvisitdate

participantsnoduplicates <- subset(participants, !coid_assedate %in% idvisitstoremove)

freqcheck <- as.data.frame(freq(participantsnoduplicates$coid_assedate))
freqcheck <- rownames_to_column(freqcheck, var="idvisitdate")
freqcheck <- freqcheck[freqcheck$idvisitdate != c("Total", "<NA>"),]
```


*********************************

------Medication: cleaning ------

Let's start by cleaning medication data frame (units, typos, standardised doses)
Create unique identifier of coid_assedate
```{r : making medication_clean df}
medication_clean <- medication

medication_clean$coid_asse_id <- paste(medication_clean$CO.ID, medication_clean$Assessment.ID)

# adding assessment date to medication frame
assessment_dates <- select(participantsnoduplicates, c("Assessment.ID", "Date.of.Assessment"))

medication_clean <- left_join(medication_clean, assessment_dates, by = "Assessment.ID")

medication_clean$Date.of.Assessment <- as.Date(medication_clean$Date.of.Assessment, format = "%d/%m/%Y")

# formatting time
medication_clean$Time <- ifelse(medication_clean$Time !=0, as.numeric(medication_clean$Time),NA)

medication_clean$Time <- as.numeric(medication_clean$Time / 3600)

medication_clean$Time <- round(medication_clean$Time, digits = 2)
```

Now let's check what units have been used to see if we need to standardise any...
Assuming that NULL units are also mg.
```{r : clean medication units}
print("Let's see which units have been used:")
table(medication_clean$Unit)

# identify entries which used anomalous units
units_mcg <- subset(medication_clean, Unit == "mcg")

#correct the dose value by /1000 (mcg to mg)
medication_clean$Dose <-
  ifelse(medication_clean$Unit == "mcg",
         as.numeric(medication_clean$Dose) / 1000,
         as.numeric(medication_clean$Dose))

#correct the unit name (also include the NULL units here) - MIGHT WANT TO REMOVE THIS TO ALLOW QUALITY CHECKING LATER - MAYBE SOME ENTRIES INCLUDE MCG VALUES BUT SAY THEY'RE MG...
medication_clean$Unit <-
  ifelse(medication_clean$Unit == "mcg" | medication_clean$Unit == "NULL",
         as.character("mg"),
         as.character(medication_clean$Unit))

#checking that all units are the same (mcg)
table(medication_clean$Unit)
```

For direct medication comparisons to be useful, we need to convert prednisolone and dexamethasone doses to HC equivalent doses.
Firstly, I need to fix entries where the medication is 'other' and the note section says '0fmody' (i.e. Efmody). I need to change 'other' to 'Efmody'.

```{r : standardise medication doses}
# writing Efmody in Medicine column where it is written in Note column
medication_clean$Medicine <- 
  ifelse(medication_clean$Note == "0fmody", (as.character("Efmody")), medication_clean$Medicine)

medication_clean$Medicine <- 
  ifelse(grepl("hydro", medication_clean$Note, ignore.case = TRUE), (as.character("IM Hydrocortisone")), medication_clean$Medicine)

# ********* IGNORE IF NOT USING FEB25 DATA *********

# Looking at 'checkdailymedstats' there's an obvious error.
# - There's an entry of 'HC' with a dose of '100mg' which is way too high. Could be that the medicine should be IM HC or that the dose should be 10mg...
# - Based on the fact that the erroneous record (line 779 in medication_clean) represents the 4th dose for a patient, it's more likely that the medicine is wrong (it's common for the 4th dose to be IM HC) and that it should be IM HC instead of HC.

# Let's fix it!
medication_clean$Medicine[779] = "IM Hydrocortisone"

# ********* IGNORE IF NOT USING FEB25 DATA *********

# HCe ratios
prednisoloneratio <- 5
dexamethasoneratio <- 80

# add in HCe values
medication_clean$HCeq_dose <- NA
medication_clean$HCeq_dose <- as.character(medication_clean$HCeq_dose)

medication_clean$HCeq_dose <- 
  ifelse(medication_clean$Medicine == "Hydrocortisone" | medication_clean$Medicine == "Efmody", medication_clean$Dose, NA)

medication_clean$HCeq_dose <- 
  ifelse(medication_clean$Medicine == "Prednisolone", (as.numeric(medication_clean$Dose) * prednisoloneratio), medication_clean$HCeq_dose)

medication_clean$HCeq_dose <- 
  ifelse(medication_clean$Medicine == "Dexamethasone", (as.numeric(medication_clean$Dose) * dexamethasoneratio), medication_clean$HCeq_dose)
```


To check that the modified values seem sensible, let's run some basic stats to check for outliers/abnormal values.
I DON'T REALLY KNOW WHAT ARE SENSIBLE RANGES/VALUES...
```{r : basic med stats for outliers}
# Let's do it first using individual doses
checkmedstats <- medication_clean %>%
  group_by(Medicine) %>%
  summarise(mean_dose = mean(HCeq_dose, na.rm = TRUE),
            median_dose = median(HCeq_dose, na.rm = TRUE),
            sd_dose = sd(HCeq_dose, na.rm = TRUE),
            min_dose = min(HCeq_dose, na.rm = TRUE),
            max_dose = max(HCeq_dose, na.rm = TRUE)) %>%
  mutate_if(is.numeric, ~round(., 2))

# Now let's do it for total_daily_doses
# calculate total daily HCeq doses per patient
medperpatient <- medication_clean %>%
  group_by(Assessment.ID) %>%
  summarise(total_daily_HCeq_dose = sum(HCeq_dose, na.rm = TRUE))

# join ^ to medication_clean
medication_clean <- full_join(medication_clean, medperpatient, by = "Assessment.ID")

checkdailymedstats <- medication_clean %>%
  group_by(Medicine) %>%
  summarise(mean_standardised_dose = mean(total_daily_HCeq_dose, na.rm = TRUE),
            median_standardised_dose = median(total_daily_HCeq_dose, na.rm = TRUE),
            sd_standardised_dose = sd(total_daily_HCeq_dose, na.rm = TRUE),
            min_standardised_dose = min(total_daily_HCeq_dose, na.rm = TRUE),
            max_standardised_dose = max(total_daily_HCeq_dose, na.rm = TRUE)) %>%
  mutate_if(is.numeric, ~round(., 2))
```


```{r : isolating IM HC and 'other' meds}
# isolate IM HC
IM_HC <- subset(medication_clean, Medicine == "IM Hydrocortisone")

# isolate 'other' medicine
othermeds <- subset(medication_clean, Medicine == "Other")
```

Now you have a cleaned medication frame:
  * units have been standardised
  * basic checks for outliers have been done (checkmedstats and checkdailymedstats)
  * Efmody and IM HC have both been correctly added into Medicine column (from note column)
  * HCeq values have been added (pred *5, dex *40)
  * Entries with 'IM HC' and 'Other' medicines have been isolated (othermeds)



*********************************
*********************************
------Medication: making meds_wide ------
A single patient visit may have more than one entry in the medication frame (multiple entries for multiple doses recorded at the same visit). Therefore, we need to widen the medication frame to put each duplicate visit for a new dose into a single row for a single visit.
```{r : making meds_wide}
medication_clean$assessment_entry <-
  ave(medication_clean$CO.ID,
      medication_clean$Assessment.ID,
      FUN = seq_along)

totalmed_1st_entry <- 
  medication_clean %>% 
  filter(assessment_entry==1)

totalmed_2nd_entry <- 
  medication_clean %>% 
  filter(assessment_entry==2)

totalmed_3rd_entry <- 
  medication_clean %>% 
  filter(assessment_entry==3)

totalmed_4th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==4)

totalmed_5th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==5)

totalmed_6th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==6)

#now we can get rid of the assessment entry column
# medication$assessment_entry <- NULL

totalmed_1st_entry$assessment_entry <- NULL

totalmed_2nd_entry$assessment_entry <- NULL

totalmed_3rd_entry$assessment_entry <- NULL

totalmed_4th_entry$assessment_entry <- NULL

totalmed_5th_entry$assessment_entry <- NULL

totalmed_6th_entry$assessment_entry <- NULL

#then add the appropriate suffix based on the assessment_entry number to each column in these frames to make them different before joining
colnames(totalmed_1st_entry) <- 
  paste(colnames(totalmed_1st_entry), 1, sep="_")

colnames(totalmed_2nd_entry) <- 
  paste(colnames(totalmed_2nd_entry), 2, sep="_")

colnames(totalmed_3rd_entry) <- 
  paste(colnames(totalmed_3rd_entry), 3, sep="_")

colnames(totalmed_4th_entry) <- 
  paste(colnames(totalmed_4th_entry), 4, sep="_")

colnames(totalmed_5th_entry) <- 
  paste(colnames(totalmed_5th_entry), 5, sep="_")

colnames(totalmed_6th_entry) <- 
  paste(colnames(totalmed_6th_entry), 6, sep="_")

totalmed_1st_entry <- totalmed_1st_entry %>%
  rename("CO.ID" = "CO.ID_1",
         "Assessment.ID" = "Assessment.ID_1")

totalmed_2nd_entry <- totalmed_2nd_entry %>%
  rename("CO.ID" = "CO.ID_2",
         "Assessment.ID" = "Assessment.ID_2")

totalmed_3rd_entry <- totalmed_3rd_entry %>%
  rename("CO.ID" = "CO.ID_3",
         "Assessment.ID" = "Assessment.ID_3")

totalmed_4th_entry <- totalmed_4th_entry %>%
  rename("CO.ID" = "CO.ID_4",
         "Assessment.ID" = "Assessment.ID_4")

totalmed_5th_entry <- totalmed_5th_entry %>%
  rename("CO.ID" = "CO.ID_5",
         "Assessment.ID" = "Assessment.ID_5")

totalmed_6th_entry <- totalmed_6th_entry %>%
  rename("CO.ID" = "CO.ID_6",
         "Assessment.ID" = "Assessment.ID_6")
```

```{r : joining widened med frames together}
meds_wide <- totalmed_1st_entry %>%
  left_join(totalmed_2nd_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_3rd_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_4th_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_5th_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_6th_entry, by=c("CO.ID", "Assessment.ID"))

#add in 'total daily dose' from 'medperpatient' to meds_wide
totaldailyformedswide <- select(medperpatient, c("Assessment.ID", "total_daily_HCeq_dose"))

meds_wide <- meds_wide %>%
  left_join(select(medperpatient, Assessment.ID, total_daily_HCeq_dose), by = "Assessment.ID")

meds_wide <- meds_wide %>%
  select_if(function(x) !all(is.na(x)))

# let's add in the number of doses per patient
meds_wide$`number of doses` <- medication_clean %>%
  group_by(coid_asse_id) %>%
  summarise("number of doses" = max(assessment_entry))

remove(totalmed_1st_entry, totalmed_2nd_entry, totalmed_3rd_entry, totalmed_4th_entry, totalmed_5th_entry, totalmed_6th_entry)

# drop unnecessary columns from meds_wide (e.g.: duplicated 'coid_asse_date')
meds_wide <- meds_wide[-c(12, 19, 20, 22, 29, 30, 32, 37, 38, 39)]
```
Now we have a single line per visit and all doses in a single row.


*********************************
*********************************
------Biomarkers: making labs_wide ------

```{r : labs_wide, include=FALSE}
valuesdrop <- c("Result", "Time")
labsvalues <- labs[, !names(labs) %in% valuesdrop]
labsvalues <- labsvalues %>%
  pivot_wider(names_from = "Type",
              values_from = "Value")

interpdrop <- c("Value", "Time")
labsinterp <- labs[, !names(labs) %in% interpdrop]
labsinterp <- labsinterp %>%
  pivot_wider(names_from = "Type",
              values_from = "Result")

labs_wide <- left_join(labsvalues, labsinterp, by = c("CO.ID", "Assessment.ID", "Date"))

names(labs_wide) <- gsub(x = names(labs_wide), pattern = ".x",
                        replacement = ".value")
names(labs_wide) <- gsub(x = names(labs_wide), pattern = ".y",
                        replacement = ".interpretation")
```

Let's extract specific biomarkers of interest
- 17OHP
- andro
- renin (convert to plasma renin activity by *0.158)
- glucose

```{r : labs biomarker subset}
CAH_biomarkers <- select(labs_wide, c("Assessment.ID", "CO.ID", "Date", "17-OHP.value", "17-OHP.interpretation", "Androstenedione.value", "Androstenedione.interpretation", "Renin.value", "Renin.interpretation", "Total testosterone.value", "Total testosterone.interpretation", "Glucose.value", "Glucose.interpretation"))

# 17-OHP
CAH_biomarkers$`17-OHP.unit` <- str_extract(CAH_biomarkers$`17-OHP.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`17-OHP.value` <- as.numeric(str_extract(CAH_biomarkers$`17-OHP.value`, "[0-9]+.?[0-9]*+"))

# androstenedione
CAH_biomarkers$`Androstenedione.unit` <- str_extract(CAH_biomarkers$`Androstenedione.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`Androstenedione.value` <- as.numeric(str_extract(CAH_biomarkers$`Androstenedione.value`, "[0-9]+.?[0-9]*+"))

# testosterone
CAH_biomarkers$`Total.testosterone.unit` <- str_extract(CAH_biomarkers$`Total testosterone.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`Total testosterone.value` <- as.numeric(str_extract(CAH_biomarkers$`Total testosterone.value`, "[0-9]+.?[0-9]*+"))

# renin
CAH_biomarkers$`Renin.unit` <- str_extract(CAH_biomarkers$`Renin.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`Renin.value` <- as.numeric(str_extract(CAH_biomarkers$`Renin.value`, "[0-9]+.?[0-9]*+"))

CAH_biomarkers$Renin.plasma.activity <- (CAH_biomarkers$Renin.value * 0.158)
CAH_biomarkers$Renin.plasma.activity <- round(CAH_biomarkers$Renin.plasma.activity, digits = 2)

# glucose
CAH_biomarkers$Glucose.unit <- str_extract(CAH_biomarkers$Glucose.value, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$Glucose.value <- as.numeric(str_extract(CAH_biomarkers$Glucose.value, "[0-9]+.?[0-9]*+"))

CAH_biomarkers_order <- c("Assessment.ID", "CO.ID", "Date", "17-OHP.value", "17-OHP.unit", "17-OHP.interpretation", "Androstenedione.value", "Androstenedione.unit", "Androstenedione.interpretation", "Renin.value", "Renin.unit", "Renin.interpretation", "Renin.plasma.activity", "Total testosterone.value", "Total.testosterone.unit", "Total testosterone.interpretation", "Glucose.value", "Glucose.interpretation")
CAH_biomarkers <- CAH_biomarkers[, CAH_biomarkers_order]
```



```{r : write outputs}

# participantsnoduplicates (for sex and age distributions)
write.csv(participantsnoduplicates, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/participantsnoduplicatesFeb25.csv", row.names = F)

# medication_clean
write.csv(medication_clean, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/medication_cleanFeb25.csv", row.names = F)

# meds_wide
write.csv(meds_wide, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/meds_wideFeb25.csv", row.names = F)

# labs_wide
write.csv(labs_wide, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/labs_wideFeb25.csv", row.names = F)


```


```{r : script completion message}
print("Script complete")
```


blank
