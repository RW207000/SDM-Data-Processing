---
title: "Cleaning Feb25"
author: "R.Welch"
date: "2025-05-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*********************************
*********************************
------Script set up------

```{r : reading libraries, include= FALSE}
packages <- c("tidyverse", "readxl", "dplyr", "magrittr", "mixtools", "emmeans", "readr","data.table", "lubridate", "ggplot2", "magrittr", "skimr", "ggstatsplot","summarytools", "knitr", "here", "ggthemes", "ggthemes", "Amelia", "tidyr", "naniar", "stringr", "janitor", "readxl")

lapply(packages, library, character.only = TRUE)
```


```{r : reading in data}
participants <- read.csv("Data/1 Registry extracts/Feb 25 Extract/Longitudinal data 24.02.2025.csv",header=T, na.strings="")
participants$Date.of.Assessment <- as.Date(participants$Date.of.Assessment, format = "%d/%m/%Y")

medication <- read.csv("Data/1 Registry extracts/Feb 25 Extract/Glucocorticoids Data 24.02.2025.csv", header=T, na.strings= c("", "NA"))
medication <- remove_empty(medication, c("cols"), cutoff = 1)

labs <- read.csv("Data/1 Registry extracts/Feb 25 Extract/Labs data 24.02.2025.csv", header=T, na.strings= c("", "NA"))
labs$Date <- as.Date(labs$Date, format = "%d/%m/%Y")
```

*********************************
*********************************
------Removing duplicates------

Making unique identifier for each assessment by combining co-id and assessment date.
```{r : making new unique identifier}
participants$coid_assedate <- paste(participants$CO.ID, participants$Date.of.Assessment, sep = " ")
```

Checking for any duplicate entries (i.e.: any duplicates in the newly made unique identifier).
'list of duplicates frame' gives output of duplicate candidates
```{r : checking for duplicates}
duplicates <- freq(participants$coid_assedate)
duplicatesframe <- as.data.frame(duplicates)
duplicatesframe <- rownames_to_column(duplicatesframe, var="idvisitdate")
```

Now to remove any non-duplicates in 'duplicatesframe' to show us what the actual duplicates are and how many times they've been duplicated
```{r : isolating duplicate occurances, include= FALSE}
duplicatesframe <- duplicatesframe[duplicatesframe$idvisitdate != c("Total", "<NA>"),]
duplicatesframe <- duplicatesframe[-c(3:6)]

duplicateassessments <- duplicatesframe %>%
  filter(Freq>1)
```

Make a new vector to use as list of duplicate entries to remove from participants dataframe and then remove duplicated entries from participants dataframe with a subset.
Because there's no way of knowing which duplicate entry is the correct one, all duplicates are removed.
```{r : removing duplicates, include=FALSE}
idvisitstoremove <- duplicateassessments$idvisitdate

participantsnoduplicates <- subset(participants, !coid_assedate %in% idvisitstoremove)

freqcheck <- as.data.frame(freq(participantsnoduplicates$coid_assedate))
freqcheck <- rownames_to_column(freqcheck, var="idvisitdate")
freqcheck <- freqcheck[freqcheck$idvisitdate != c("Total", "<NA>"),]

# freqcheck
```

Making a dataframe of the removed duplicate assessment entries
```{r : removed duplicates}
toremove <- duplicateassessments$idvisitdate
removedrecords <- subset(participants, coid_assedate %in% toremove)

write.csv(removedrecords, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/removed_records", row.names = F)
```

Because I've removed all duplicate assessment entries, we might have lost participant/s if their only entry is one of these removed duplicates.
This will show which participants, if any, have been lost.
```{r : identifying lost participants}
duplicateassessments$id <- sapply(strsplit(duplicateassessments$idvisitdate," "), `[`, 1)
duplicateassessments$visitdate<- sapply(strsplit(duplicateassessments$idvisitdate," "), `[`, 2)

toremovelostparticipants <- participantsnoduplicates$CO.ID

lostparticipants <- NA
lostparticipants <- subset(participants, !CO.ID %in% toremovelostparticipants)
```

```{r : making participantsnoduplicates}
idvisitstoremove <- duplicateassessments$idvisitdate

participantsnoduplicates <- subset(participants, !coid_assedate %in% idvisitstoremove)

freqcheck <- as.data.frame(freq(participantsnoduplicates$coid_assedate))
freqcheck <- rownames_to_column(freqcheck, var="idvisitdate")
freqcheck <- freqcheck[freqcheck$idvisitdate != c("Total", "<NA>"),]
```


*********************************

------Medication: cleaning ------

Let's start by cleaning medication data frame (units, typos, standardised doses)
Create unique identifier of coid_assedate
```{r: making medication_clean df}
medication_clean <- medication

medication_clean$coid_asse_id <- paste(medication_clean$CO.ID, medication_clean$Assessment.ID)

# adding assessment date to medication frame
assessment_dates <- select(participantsnoduplicates, c("Assessment.ID", "Date.of.Assessment"))

medication_clean <- left_join(medication_clean, assessment_dates, by = "Assessment.ID")

medication_clean$Date.of.Assessment <- as.Date(medication_clean$Date.of.Assessment, format = "%d/%m/%Y")

# formatting time

```

Now let's check what units have been used to see if we need to standardise any...
Assuming that NULL units are also mg.
```{r : clean medication units}
print("Let's see which units have been used:")
table(medication_clean$Unit)

# identify entries which used anomalous units
units_mcg <- subset(medication_clean, Unit == "mcg")

#correct the dose value by /1000 (mcg to mg)
medication_clean$Dose <-
  ifelse(medication_clean$Unit == "mcg",
         as.numeric(medication_clean$Dose) / 1000,
         as.numeric(medication_clean$Dose))

#correct the unit name (also include the NULL units here) - MIGHT WANT TO REMOVE THIS TO ALLOW QUALITY CHECKING LATER - MAYBE SOME ENTRIES INCLUDE MCG VALUES BUT SAY THEY'RE MG...
medication_clean$Unit <-
  ifelse(medication_clean$Unit == "mcg" | medication_clean$Unit == "NULL",
         as.character("mg"),
         as.character(medication_clean$Unit))

#checking that all units are the same (mcg)
table(medication_clean$Unit)
```

For direct medication comparisons to be useful, we need to convert prednisolone and dexamethasone doses to HC equivalent doses.
Firstly, I need to fix entries where the medication is 'other' and the note section says '0fmody' (i.e. Efmody). I need to change 'other' to 'Efmody'.

```{r : standardise medication doses}
# writing Efmody in Medicine column where it is written in Note column
medication_clean$Medicine <- 
  ifelse(medication_clean$Note == "0fmody", (as.character("Efmody")), medication_clean$Medicine)

# HCe ratios
prednisoloneratio <- 5
dexamethasoneratio <- 80

# add in HCe values
medication_clean$HC_equivalent_dose <- NA
medication_clean$HC_equivalent_dose <- as.character(medication_clean$HC_equivalent_dose)

medication_clean$HC_equivalent_dose <- 
  ifelse(medication_clean$Medicine == "Hydrocortisone" | medication_clean$Medicine == "Efmody", medication_clean$Dose, NA)

medication_clean$HC_equivalent_dose <- 
  ifelse(medication_clean$Medicine == "Prednisolone", (as.numeric(medication_clean$Dose) * prednisoloneratio), medication_clean$HC_equivalent_dose)

medication_clean$HC_equivalent_dose <- 
  ifelse(medication_clean$Medicine == "Dexamethasone", (as.numeric(medication_clean$Dose) * dexamethasoneratio), medication_clean$HC_equivalent_dose)
```

To check that the modified values seem sensible, let's run some basic stats to check for outliers/abnormal values.
I DON'T REALLY KNOW WHAT ARE SENSIBLE RANGES/VALUES...
```{r : basic med stats for outliers}
# Let's do it first using individual doses
checkmedstats <- medication_clean %>%
  group_by(Medicine) %>%
  summarise(mean_dose = mean(HC_equivalent_dose, na.rm = TRUE),
            median_dose = median(HC_equivalent_dose, na.rm = TRUE),
            sd_dose = sd(HC_equivalent_dose, na.rm = TRUE),
            min_dose = min(HC_equivalent_dose, na.rm = TRUE),
            max_dose = max(HC_equivalent_dose, na.rm = TRUE)) %>%
  mutate_if(is.numeric, ~round(., 2))

# Now let's do it for total_daily_doses
medperpatient <- medication_clean %>%
  group_by(Assessment.ID) %>%
  summarise(total_standardised_daily_dose_1 = sum(HC_equivalent_dose, na.rm = TRUE))

medication_clean <- full_join(medication_clean, medperpatient, by = "Assessment.ID")

checkdailymedstats <- medication_clean %>%
  group_by(Medicine) %>%
  summarise(mean_standardised_dose = mean(total_standardised_daily_dose_1, na.rm = TRUE),
            median_standardised_dose = median(total_standardised_daily_dose_1, na.rm = TRUE),
            sd_standardised_dose = sd(total_standardised_daily_dose_1, na.rm = TRUE),
            min_standardised_dose = min(total_standardised_daily_dose_1, na.rm = TRUE),
            max_standardised_dose = max(total_standardised_daily_dose_1, na.rm = TRUE)) %>%
  mutate_if(is.numeric, ~round(., 2))
```

```{r}
medication_clean$Time <- ifelse(medication_clean$Time !=0, as.numeric(medication_clean$Time),NA)

medication_clean$Time <- as.numeric(medication_clean$Time / 3600)

medication_clean$Time <- round(medication_clean$Time, digits = 2)
```

*********************************
*********************************
------Medication: making meds_wide ------
A single patient visit may have more than one entry in the medication frame (multiple entries for multiple doses recorded at the same visit). Therefore, we need to widen the medication frame to put each duplicate visit for a new dose into a single row for a single visit.
```{r : making meds_wide}
medication_clean$assessment_entry <-
  ave(medication_clean$CO.ID,
      medication_clean$Assessment.ID,
      FUN = seq_along)

totalmed_1st_entry <- 
  medication_clean %>% 
  filter(assessment_entry==1)

totalmed_2nd_entry <- 
  medication_clean %>% 
  filter(assessment_entry==2)

totalmed_3rd_entry <- 
  medication_clean %>% 
  filter(assessment_entry==3)

totalmed_4th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==4)

totalmed_5th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==5)

totalmed_6th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==6)

#now we can get rid of the assessment entry column
# medication$assessment_entry <- NULL

totalmed_1st_entry$assessment_entry <- NULL

totalmed_2nd_entry$assessment_entry <- NULL

totalmed_3rd_entry$assessment_entry <- NULL

totalmed_4th_entry$assessment_entry <- NULL

totalmed_5th_entry$assessment_entry <- NULL

totalmed_6th_entry$assessment_entry <- NULL

#then add the appropriate suffix based on the assessment_entry number to each column in these frames to make them different before joining
colnames(totalmed_1st_entry) <- 
  paste(colnames(totalmed_1st_entry), 1, sep="_")

colnames(totalmed_2nd_entry) <- 
  paste(colnames(totalmed_2nd_entry), 2, sep="_")

colnames(totalmed_3rd_entry) <- 
  paste(colnames(totalmed_3rd_entry), 3, sep="_")

colnames(totalmed_4th_entry) <- 
  paste(colnames(totalmed_4th_entry), 4, sep="_")

colnames(totalmed_5th_entry) <- 
  paste(colnames(totalmed_5th_entry), 5, sep="_")

colnames(totalmed_6th_entry) <- 
  paste(colnames(totalmed_6th_entry), 6, sep="_")

totalmed_1st_entry <- totalmed_1st_entry %>%
  rename("CO.ID" = "CO.ID_1",
         "Assessment.ID" = "Assessment.ID_1")

totalmed_2nd_entry <- totalmed_2nd_entry %>%
  rename("CO.ID" = "CO.ID_2",
         "Assessment.ID" = "Assessment.ID_2")

totalmed_3rd_entry <- totalmed_3rd_entry %>%
  rename("CO.ID" = "CO.ID_3",
         "Assessment.ID" = "Assessment.ID_3")

totalmed_4th_entry <- totalmed_4th_entry %>%
  rename("CO.ID" = "CO.ID_4",
         "Assessment.ID" = "Assessment.ID_4")

totalmed_5th_entry <- totalmed_5th_entry %>%
  rename("CO.ID" = "CO.ID_5",
         "Assessment.ID" = "Assessment.ID_5")

totalmed_6th_entry <- totalmed_6th_entry %>%
  rename("CO.ID" = "CO.ID_6",
         "Assessment.ID" = "Assessment.ID_6")
```

```{r : joining widened med frames together}
meds_wide <- totalmed_1st_entry %>%
  left_join(totalmed_2nd_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_3rd_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_4th_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_5th_entry, by=c("CO.ID", "Assessment.ID")) %>%
  left_join(totalmed_6th_entry, by=c("CO.ID", "Assessment.ID"))

#add in 'total daily dose' from 'medperpatient' to meds_wide
totaldailyformedswide <- select(medperpatient, c("Assessment.ID", "total_standardised_daily_dose_1"))

meds_wide <- meds_wide %>%
  left_join(select(medperpatient, Assessment.ID, total_standardised_daily_dose_1), by = "Assessment.ID")

meds_wide <- meds_wide %>%
  select_if(function(x) !all(is.na(x)))

# write.csv(meds_wide, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/meds_wide.csv", row.names = F)


remove(totalmed_1st_entry, totalmed_2nd_entry, totalmed_3rd_entry, totalmed_4th_entry, totalmed_5th_entry, totalmed_6th_entry)
```
Now we have a single line per visit and all doses in a single row.

Now to add in the number of doses onto 'medperpatient' (couldn't do this earlier because widening meds is what introduces assessment entry numbers)
```{r : doses per patient}
medperpatient$number_of_doses <- medication_clean %>%
  group_by(Assessment.ID) %>%
  summarise(max(assessment_entry))

patient_medicine <- select(meds_wide, c("Assessment.ID", "Medicine_1"))
patient_w_h <- select(participantsnoduplicates, c("Assessment.ID", "Weight..kg.", "Height..cm."))
absolute_med_values <- select(meds_wide, )


medperpatient <- left_join(medperpatient, patient_medicine, by = "Assessment.ID")
medperpatient <- left_join(medperpatient, patient_w_h, join_by("Assessment.ID" == "Assessment.ID"))

# write.csv(medperpatient, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/medperpatient.csv", row.names = F)
```

*********************************

------Medication: making labs_wide ------

```{r : labs_wide, include=FALSE}
valuesdrop <- c("Result", "Time")
labsvalues <- labs[, !names(labs) %in% valuesdrop]
labsvalues <- labsvalues %>%
  pivot_wider(names_from = "Type",
              values_from = "Value")

interpdrop <- c("Value", "Time")
labsinterp <- labs[, !names(labs) %in% interpdrop]
labsinterp <- labsinterp %>%
  pivot_wider(names_from = "Type",
              values_from = "Result")

labs_wide <- left_join(labsvalues, labsinterp, by = c("CO.ID", "Assessment.ID", "Date"))

names(labs_wide) <- gsub(x = names(labs_wide), pattern = ".x",
                        replacement = ".value")
names(labs_wide) <- gsub(x = names(labs_wide), pattern = ".y",
                        replacement = ".interpretation")
```







```{r : script completion message}
print("Script complete")
```


blank
